<html lang="ja">
	<head>
		<title>Ajax</title>
	</head>
	<body>
		<div class="container">
			<h2>数値の入力</h2>
			<form id="ajax-number" action="{% url 'app_urls:ajax_number' %}" method="POST">
				{% csrf_token %}
				<input type="range" id="ajax-slider" min="0" max="100" value="50" step="10">
			</form>
			<div class="result">
				<p>スライダーの値：</p>
			</div>
		</div>

		<!-- jQueryの読み込み -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script>
			// ----- Ajax前のおまじない start -----
			function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie !== '') {
					var cookies = document.cookie.split(';');
					for (var i = 0; i < cookies.length; i++) {
						var cookie = jQuery.trim(cookies[i]);
						// Does this cookie string begin with the name we want?
						if (cookie.substring(0, name.length + 1) === (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							break;
						}
					}
				}
				return cookieValue;
			}
			var csrftoken = getCookie('csrftoken');
			function csrfSafeMethod(method) {
				// these HTTP methods do not require CSRF protection
				return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
			}
			$.ajaxSetup({
				beforeSend: function (xhr, settings) {
					if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
						xhr.setRequestHeader("X-CSRFToken", csrftoken);
					}
				}
			});
			// ----- Ajax前のおまじない end -----

			// submitイベントを検知する
			// inputにするとリアルタイムでajaxが可能
			$('#ajax-slider').on('input', function(e) {
				// フォームでsubmitが押されたときに、フォーム送信の通信を止めるためにpreventDefault()を使用
				e.preventDefault();

				// サーバに送信するリクエストの設定
				$.ajax({
					// リクエストを送信するURLを指定
					// jsを外部に設置するとDjangoのテンプレが使えないのでエラーになる
					'url': '{% url "app_urls:ajax_number" %}',
					// HTTPメソッドのGET通信かPOST通信を指定
					'type': 'POST',
					// サーバに送信するデータの指定
					'data': {
						'num': $('#ajax-slider').val(),
					},
					// データ形式（ここではjson）を指定
					'dataType': 'json'
				})
				// 通信成功時の処理
				// views.pyから受け取ったJSONデータをページに表示
				.done(function(response){
					$('.result p').replaceWith('<p>スライダーの値：' + response.num + '</p>');
				})
				// 通信失敗時の処理
				.fail(function(){
					window.alert("error");
				});
			});
		</script>
	</body>
</html>